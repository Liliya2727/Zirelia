#!/bin/sh

#
# Copyright (C) 2024-2025 Zexshia
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

MODDIR=${0%/*}

zeshia() {
	if [ -f $2 ]; then
		chmod 644 $2 >/dev/null 2>&1
		echo $1 >$2 2>/dev/null
		chmod 444 $2 >/dev/null 2>&1
	fi
}
# Logging 
sendlog() {
    local LEVEL="$1"
    local MODULE="$2"
    local MESSAGE="$3"
    local TIMESTAMP
    TIMESTAMP="$(date '+%Y-%m-%d %H:%M:%S.%3N')"
    echo "$TIMESTAMP $LEVEL $MODULE: $MESSAGE" >> /data/adb/.config/encore/encore.log
}
#############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

# Define important libs
lib="UnityMain, libunity.so, libil2ccp.so, libmain.so"

settunes() {
    local policy_path="$1"

    # Check if the policy path exists
    if [ ! -d "$policy_path" ]; then
        echo "Skipped: $policy_path (not available)"
        return
    fi
    
    # Read available frequencies
    local available_freqs=$(cat "$policy_path/scaling_available_frequencies" 2>/dev/null)
    if [ -z "$available_freqs" ]; then
        echo "Skipped: No available frequencies for $policy_path"
        return
    fi
    
    # Select the 6 highest frequencies
    local selected_freqs=$(echo "$available_freqs" | tr ' ' '\n' | sort -rn | head -n 6 | tr '\n' ' ' | sed 's/ $//')
    
    # Generate up_delay values dynamically
    local num_freqs=$(echo "$selected_freqs" | wc -w)
    local up_delay=""
    for i in $(seq 1 $num_freqs); do
        up_delay="$up_delay $((50 * i))"
    done
    up_delay=$(echo "$up_delay" | sed 's/^ //')

    # Define universal rate values
    local up_rate=7000
    local down_rate=15000

    # Check for schedhorizon and schedutil paths
    local schedhorizon_path="$policy_path/schedhorizon"
    local schedutil_path="$policy_path/schedutil"

    if [ -d "$schedhorizon_path" ]; then
        zeshia "$up_delay" "$schedhorizon_path/up_delay"
        zeshia "$selected_freqs" "$schedhorizon_path/efficient_freq"
        zeshia "$up_rate" "$schedhorizon_path/up_rate_limit_us"
        zeshia "$down_rate" "$schedhorizon_path/down_rate_limit_us"
    fi

    if [ -d "$schedutil_path" ]; then
        zeshia "$up_rate" > "$schedutil_path/up_rate_limit_us"
        zeshia "$down_rate" > "$schedutil_path/down_rate_limit_us"
    fi
}
for policy in /sys/devices/system/cpu/cpufreq/policy*; do
    settunes "$policy"
done


fpsgoandgedparams() {
# GED parameters
ged_params="ged_smart_boost 1
boost_upper_bound 100
enable_gpu_boost 1
enable_cpu_boost 1
ged_boost_enable 1
boost_gpu_enable 1
gpu_dvfs_enable 1
gx_frc_mode 1
gx_dfps 1
gx_force_cpu_boost 1
gx_boost_on 1
gx_game_mode 1
gx_3D_benchmark_on 1
gpu_loading 0
cpu_boost_policy 1
boost_extra 1
is_GED_KPI_enabled 0"

zeshia "$ged_params" | while read -r param value; do
    zeshia "$value" "/sys/module/ged/parameters/$param"
done

# FPSGO Configuration
zeshia "0" /sys/kernel/fpsgo/fbt/boost_ta
zeshia "1" /sys/kernel/fpsgo/fbt/enable_switch_down_throttle
zeshia "1" /sys/kernel/fpsgo/fstb/adopt_low_fps
zeshia "1" /sys/kernel/fpsgo/fstb/fstb_self_ctrl_fps_enable
zeshia "0" /sys/kernel/fpsgo/fstb/boost_ta
zeshia "1" /sys/kernel/fpsgo/fstb/enable_switch_sync_flag
zeshia "0" /sys/kernel/fpsgo/fbt/boost_VIP
zeshia "1" /sys/kernel/fpsgo/fstb/gpu_slowdown_check
zeshia "1" /sys/kernel/fpsgo/fbt/thrm_limit_cpu
zeshia "0" /sys/kernel/fpsgo/fbt/thrm_temp_th
zeshia "0" /sys/kernel/fpsgo/fbt/llf_task_policy
zeshia 100 /sys/module/mtk_fpsgo/parameters/uboost_enhance_f
zeshia 0 /sys/module/mtk_fpsgo/parameters/isolation_limit_cap
zeshia "1" /sys/pnpmgr/fpsgo_boost/boost_enable
zeshia 1 /sys/pnpmgr/fpsgo_boost/boost_mode
zeshia 1 /sys/pnpmgr/install
zeshia "100" > /sys/kernel/ged/hal/gpu_boost_level
}


# Tweaking scheduler to reduce latency
	zeshia 50000 /proc/sys/kernel/sched_migration_cost_ns
	zeshia 1000000 /proc/sys/kernel/sched_min_granularity_ns
	zeshia 1500000 /proc/sys/kernel/sched_wakeup_granularity_ns

	# Disable read-ahead for swap devices
	zeshia 0 /proc/sys/vm/page-cluster

	# Update /proc/stat less often to reduce jitter
	zeshia 120 /proc/sys/vm/stat_interval

	# Disable compaction_proactiveness
	zeshia 0 /proc/sys/vm/compaction_proactiveness

	# Report max CPU capabilities to these libraries
	echo "libunity.so, libil2cpp.so, libmain.so, libUE4.so, libgodot_android.so, libgdx.so, libgdx-box2d.so, libminecraftpe.so, libLive2DCubismCore.so, libyuzu-android.so, libryujinx.so, libcitra-android.so, libhdr_pro_engine.so, libandroidx.graphics.path.so, libeffect.so" /proc/sys/kernel/sched_lib_name
	zeshia 255 /proc/sys/kernel/sched_lib_mask_force
	
# Memory optimizations
zeshia 10 /proc/sys/vm/swappiness

# GPU Scheduling
mali_dir=$(ls -d /sys/devices/platform/soc/*mali*/scheduling 2>/dev/null | head -n 1)
mali1_dir=$(ls -d /sys/devices/platform/soc/*mali* 2>/dev/null | head -n 1)
if [ -n "$mali_dir" ]; then
    zeshia "$mali_dir/serialize_jobs" "full"
fi
if [ -n "$mali1_dir" ]; then
    zeshia "$mali1_dir/js_ctx_scheduling_mode" "1"
fi

# Block I/O optimizations with reduced redundant operations
for block in mmcblk0 mmcblk1 sda sdb sdc; do
    for param in add_random iostats nomerges rotational rq_affinity; do
        zeshia "0" "/sys/block/$block/queue/$param"
    done
    zeshia "64" "/sys/block/$block/queue/nr_requests"
    zeshia "128" "/sys/block/$block/queue/read_ahead_kb"
done

# Network settings with logging
zeshia "cubic" /proc/sys/net/ipv4/tcp_congestion_control
zeshia 1 /proc/sys/net/ipv4/tcp_low_latency

# Virtual memory settings
zeshia 35 /proc/sys/vm/dirty_background_ratio
zeshia 30 /proc/sys/vm/dirty_ratio
zeshia 120 /proc/sys/vm/vfs_cache_pressure
zeshia 400 /proc/sys/vm/dirty_expire_centisecs
zeshia 6000 /proc/sys/vm/dirty_writeback_centisecs
zeshia 0 /proc/sys/vm/oom_dump_tasks
zeshia 0 /proc/sys/vm/page-cluster
zeshia 0 /proc/sys/vm/block_dump
zeshia 10 /proc/sys/vm/stat_interval
zeshia 1 /proc/sys/vm/compaction_proactiveness
zeshia 1 /proc/sys/vm/watermark_boost_factor
zeshia 50 /proc/sys/vm/watermark_scale_factor
zeshia 2 /proc/sys/vm/drop_caches
zeshia 50 /proc/sys/vm/swappiness

for cs in /dev/cpuset
do
    zeshia 0-7 "$cs/cpus"
    zeshia 0-5 "$cs/background/cpus"
    zeshia 0-4 "$cs/system-background/cpus"
    zeshia 0-7 "$cs/foreground/cpus"
    zeshia 0-7 "$cs/top-app/cpus"
    zeshia 0-5 "$cs/restricted/cpus"
    zeshia 0-7 "$cs/camera-daemon/cpus"
    zeshia 0 "$cs/memory_pressure_enabled"
    zeshia 0 "$cs/sched_load_balance"
    zeshia 1 "$cs/foreground/sched_load_balance"
done

# Disallow power saving mode for display
for dlp in /proc/displowpower/*; do
    [ -f "$dlp/hrt_lp" ] && zeshia 1 "$dlp/hrt_lp"
    [ -f "$dlp/idlevfp" ] && zeshia 1 "$dlp/idlevfp"
    [ -f "$dlp/idletime" ] && zeshia 100 "$dlp/idletime"
done

zeshia 0 /dev/cpuctl/foreground/cpu.uclamp.min
zeshia 0 /dev/cpuctl/top-app/cpu.uclamp.min
zeshia 0 /dev/cpuctl/pnpmgr_fg/cpu.uclamp.min

# Disable all kernel panic mechanisms
for param in hung_task_timeout_secs panic_on_oom panic_on_oops panic softlockup_panic; do
    zeshia "0" "/proc/sys/kernel/$param"
done

# Set library names for scheduler optimization
zeshia "$lib" "/proc/sys/kernel/sched_lib_name"

FSTrim() {
    for mount in /system /vendor /data /cache /metadata /odm /system_ext /product; do
        if mountpoint -q "$mount"; then
            fstrim -v "$mount"
        fi
    done
}

SFL() {
resetprop -n debug.sf.disable_backpressure 1
resetprop -n debug.sf.latch_unsignaled 1
resetprop -n debug.sf.enable_hwc_vds 1
resetprop -n debug.sf.early_phase_offset_ns 300000
resetprop -n debug.sf.early_app_phase_offset_ns 300000
resetprop -n debug.sf.early_gl_phase_offset_ns 2000000
resetprop -n debug.sf.early_gl_app_phase_offset_ns 10000000
resetprop -n debug.sf.high_fps_early_phase_offset_ns 5000000
resetprop -n debug.sf.high_fps_early_gl_phase_offset_ns 500000
resetprop -n debug.sf.high_fps_late_app_phase_offset_ns 80000
resetprop -n debug.sf.phase_offset_threshold_for_next_vsync_ns 5000000
resetprop -n debug.sf.showupdates 0
resetprop -n debug.sf.showcpu 0
resetprop -n debug.sf.showbackground 0
resetprop -n debug.sf.showfps 0
resetprop -n debug.sf.hw 1
}


DThermal() {
    
    thermal() {
        find /system/etc/init /vendor/etc/init /odm/etc/init -type f | xargs grep -h "^service" | awk '{print $2}' | grep thermal
    }

    propfile() {
        while read -r key value; do
            resetprop -n "$key" "$value"
            echo "[$(date)] Reset $key to $value"
        done <<EOF
debug.thermal.throttle.support no
ro.vendor.mtk_thermal_2_0 0
persist.thermal_config.mitigation 0
ro.mtk_thermal_monitor.enabled false
ro.vendor.tran.hbm.thermal.temp.clr 49000
ro.vendor.tran.hbm.thermal.temp.trig 46000
vendor.thermal.link_ready 0
dalvik.vm.dexopt.thermal-cutoff 0
persist.vendor.thermal.engine.enable 0
persist.vendor.thermal.config 0
EOF
    }

    propfile

    stop thermal_core
    stop vendor.thermal-hal-2-0.mtk

    for svc in $(thermal); do
        stop "$svc"
    done

    for thermalpr in $(pgrep thermal); do
        kill -SIGSTOP "$thermalpr"        
    done

    for thermalinit in $(getprop | awk -F '[][]' '/init\.svc_.*thermal/ {print $2}'); do
        [ -n "$thermalinit" ] && resetprop -n "$thermalinit" ""
    done

    for kill in android.hardware.thermal-service.mediatek android.hardware.thermal@2.0-service.mtk; do
        getprop | grep -q "$kill" && stop "$kill"
        thermalhwsvc=$(pidof "$kill")
        [ -n "$thermalhwsvc" ] && kill -9 "$thermalhwsvc"
    done

    for kill2 in /vendor/bin/hw/android.hardware.thermal-service.mediatek /vendor/bin/hw/android.hardware.thermal@2.0-service.mtk; do
        if [ -f "$kill2" ]; then
            mv "$kill2" "$kill2.bak"
            echo "" > "$kill2"
            chmod 000 "$kill2"      
        fi
    done

    for thermalprop in $(getprop | grep thermal | cut -f1 -d] | cut -f2 -d[ | grep -F init.svc.); do
        resetprop "$thermalprop" stopped
    done

    if [ -d "/sys/class/thermal" ]; then
        chmod 644 /sys/class/thermal/thermal_zone*/mode
        for thermalzone in /sys/class/thermal/thermal_zone*/mode; do
            [ -f "$thermalzone" ] && echo "disabled" > "$thermalzone"          
        done
    fi

    [ -d "/sys/devices/virtual/thermal" ] && find /sys/devices/virtual/thermal -type f -exec chmod 000 {} +

    cmd thermalservice override-status 0  
}

kill_logd() {
    zeshia 0 /sys/kernel/ccci/debug
    zeshia 0 /sys/kernel/tracing/tracing_on        
    zeshia 0 /proc/sys/kernel/perf_event_paranoid
    zeshia 0 /proc/sys/kernel/debug_locks
    zeshia 0 /proc/sys/kernel/perf_cpu_time_max_percent
    zeshia off /proc/sys/kernel/printk_devkmsg    
}
    # List of logging services
    list_logger="
    logd
    traced
    statsd
    tcpdump
    cnss_diag
    subsystem_ramdump
    charge_logger
    wlan_logging
    "

    # Logd
    if [ -f /data/adb/.config/zirelia/logd ] && [ "$(cat /data/adb/.config/zirelia/logd)" -eq 1 ]; then
        for logger in $list_logger; do
            stop "$logger" 2>/dev/null
        done
    else
        for logger in $list_logger; do
            start "$logger" 2>/dev/null
        done
    fi
    
if [ -f /data/adb/.config/zirelia/logd ] && [ "$(cat /data/adb/.config/zirelia/logd)" -eq 1 ]; then
    kill_logd
fi
if [ -f /data/adb/.config/zirelia/DThermal ] && [ "$(cat /data/adb/.config/zirelia/DThermal)" -eq 1 ]; then
    DThermal
fi
if [ -f /data/adb/.config/zirelia/SFL ] && [ "$(cat /data/adb/.config/zirelia/SFL)" -eq 1 ]; then
    SFL
fi
if [ -f /data/adb/.config/zirelia/FSTrim ] && [ "$(cat /data/adb/.config/zirelia/FSTrim)" -eq 1 ]; then
    FSTrim
fi
if [ -f /data/adb/.config/zirelia/fpsged ] && [ "$(cat /data/adb/.config/zirelia/fpsged)" -eq 1 ]; then
    fpsgoandgedparams
fi

exit 0
####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################